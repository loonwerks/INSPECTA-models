# Do not edit this file as it will be overwritten if codegen is rerun

override MICROKIT_SDK := $(abspath ${MICROKIT_SDK})

SYSTEM_MAKEFILE ?= system.mk

export CPU = cortex-a53
export QEMU = qemu-system-aarch64

export AR := ar
export CC := clang
export DTC := dtc
export LD := ld.lld
export RANLIB := llvm-ranlib

export TOP_DIR := $(abspath $(dir ${MAKEFILE_LIST}))
export TOP_BUILD_DIR := $(abspath build)

export CRATES_DIR := $(TOP_DIR)/crates

export TARGET := aarch64-none-elf

# By default we make a debug build so that the client debug prints can be seen.
export MICROKIT_CONFIG ?= debug

export MICROKIT_SDK := $(abspath $(MICROKIT_SDK))
export MICROKIT_TOOL := $(abspath $(MICROKIT_SDK)/bin/microkit)
export MICROKIT_BOARD_DIR := $(abspath $(MICROKIT_SDK)/board/$(MICROKIT_BOARD)/$(MICROKIT_CONFIG))


IMAGE_FILE := $(TOP_BUILD_DIR)/loader.img
REPORT_FILE := $(TOP_BUILD_DIR)/report.txt

# By default, cargo-verus is used to build Rust crates, and it fails if verification does not succeed.
# To skip verification, set the RUST_MAKE_TARGET environment variable to use a cargo build target.
# Example:
#
#   RUST_MAKE_TARGET=build-release make

all: ${IMAGE_FILE}

.PHONY: check_microkit
check_microkit:
	@if [ -z "$(strip $(MICROKIT_BOARD))" ]; then \
		echo "MICROKIT_BOARD must be specified"; \
		exit 1; \
	fi
	@if [ -z "$(strip $(MICROKIT_SDK))" ]; then \
		echo "MICROKIT_SDK must be specified"; \
		exit 1; \
	fi

qemu ${IMAGE_FILE} ${REPORT_FILE}: check_microkit $(IMAGE_FILE) ${TOP_BUILD_DIR}/Makefile FORCE
	${MAKE} -C ${TOP_BUILD_DIR} $(notdir $@)

clean:: ${TOP_BUILD_DIR}/Makefile
	${MAKE} -C ${TOP_BUILD_DIR} clean

clobber:: clean
	rm -rf $(TOP_DIR)/build

${TOP_BUILD_DIR}/Makefile: $(SYSTEM_MAKEFILE)
	mkdir -p ${TOP_BUILD_DIR}
	cp $(SYSTEM_MAKEFILE) ${TOP_BUILD_DIR}/Makefile

test:: ${TOP_BUILD_DIR}/Makefile
	${MAKE} -C ${TOP_BUILD_DIR} test

FORCE:
