# Do not edit this file as it will be overwritten if codegen is rerun

ifeq ($(strip $(LIONSOS)),)
$(error LIONSOS must be specified)
endif
override LIONSOS:=$(abspath ${LIONSOS})

TOOLCHAIN := clang
CC := clang
LD := ld.lld
RANLIB := llvm-ranlib
AR := llvm-ar
OBJCOPY := llvm-objcopy
MICROKIT_TOOL ?= $(MICROKIT_SDK)/bin/microkit
DTC := dtc
PYTHON ?= python3
SDDF := $(LIONSOS)/dep/sddf

SYSTEM_FILE := arinc_scheduling.system
IMAGE_FILE := loader.img
REPORT_FILE := report.txt

SUPPORTED_BOARDS := qemu_virt_aarch64

include ${SDDF}/tools/make/board/common.mk

METAPROGRAM := $(TOP_DIR)/meta.py

SDFGEN_HELPER := $(TOP_DIR)/sdfgen_helper.py

# Macros needed by sdfgen helper to calculate config struct sizes
SDFGEN_UNKOWN_MACROS := MAX_PARTITIONS=61

# Headers containing config structs and dependencies
SCHEDULER_CONFIG_HEADERS := $(TOP_DIR)/scheduler/include/user_config.h

SDDF_CUSTOM_LIBC := 1

LDFLAGS := -L$(BOARD_DIR)/lib -L$(SDDF)/lib
LIBS := -lmicrokit -Tmicrokit.ld libsddf_util_debug.a

SDDF_MAKEFILES := ${SDDF}/util/util.mk \
	${SDDF}/drivers/timer/${TIMER_DRIV_DIR}/timer_driver.mk \
	${SDDF}/drivers/serial/${UART_DRIV_DIR}/serial_driver.mk \
	${SDDF}/serial/components/serial_components.mk

include ${SDDF_MAKEFILES}


CFLAGS += \
	-I$(LIONSOS)/include \
	-I$(SDDF)/include \
	-I$(SDDF)/include/microkit \
	-I$(TOP_DIR)/scheduler/include \
	-I$(TOP_DIR)/types/include \
	-I$(TOP_DIR)/components/producer_p_p_producer/include -I$(TOP_DIR)/components/consumer_p_p_consumer/include -I$(TOP_DIR)/components/consumer_p_s_consumer/include


UTIL_OBJS :=

TYPE_OBJS := sb_queue_int8_t_1.o


all: cache.o
CHECK_FLAGS_BOARD_MD5:=.board_cflags-$(shell echo -- ${CFLAGS} ${BOARD} ${MICROKIT_CONFIG}| shasum | sed 's/ *-//')

${CHECK_FLAGS_BOARD_MD5}:
	-rm -f .board_cflags-*
	touch $@


vpath %.c $(SDDF) \
	$(TOP_DIR)/scheduler/src \
	$(TOP_DIR)/types/src \
	$(TOP_DIR)/components/producer_p_p_producer/src $(TOP_DIR)/components/consumer_p_p_consumer/src $(TOP_DIR)/components/consumer_p_s_consumer/src


IMAGES := timer_driver.elf scheduler.elf \
	producer_p_p_producer.elf producer_p_p_producer_MON.elf consumer_p_p_consumer.elf consumer_p_p_consumer_MON.elf consumer_p_s_consumer.elf consumer_p_s_consumer_MON.elf

${IMAGES}: libsddf_util_debug.a


%.o: %.c ${SDDF}/include
	${CC} ${CFLAGS} -c -o $@ $<


producer_p_p_producer_MON.elf: producer_p_p_producer_MON_user.o producer_p_p_producer_MON.o
	$(LD) $(LDFLAGS) $^ $(LIBS) -o $@

producer_p_p_producer.elf: $(UTIL_OBJS) $(TYPE_OBJS) producer_p_p_producer_user.o producer_p_p_producer.o
	$(LD) $(LDFLAGS) $^ $(LIBS) -o $@

consumer_p_p_consumer_MON.elf: consumer_p_p_consumer_MON_user.o consumer_p_p_consumer_MON.o
	$(LD) $(LDFLAGS) $^ $(LIBS) -o $@

consumer_p_p_consumer.elf: $(UTIL_OBJS) $(TYPE_OBJS) consumer_p_p_consumer_user.o consumer_p_p_consumer.o
	$(LD) $(LDFLAGS) $^ $(LIBS) -o $@

consumer_p_s_consumer_MON.elf: consumer_p_s_consumer_MON_user.o consumer_p_s_consumer_MON.o
	$(LD) $(LDFLAGS) $^ $(LIBS) -o $@

consumer_p_s_consumer.elf: $(UTIL_OBJS) $(TYPE_OBJS) consumer_p_s_consumer_user.o consumer_p_s_consumer.o
	$(LD) $(LDFLAGS) $^ $(LIBS) -o $@



$(SYSTEM_FILE): $(METAPROGRAM) $(IMAGES) $(DTB)
	$(PYTHON) $(SDFGEN_HELPER) --macros "$(SDFGEN_UNKOWN_MACROS)" --configs "$(SCHEDULER_CONFIG_HEADERS)" --output $(TOP_BUILD_DIR)/config_structs.py
	$(PYTHON) $(METAPROGRAM) --sddf $(SDDF) --board $(MICROKIT_BOARD) --dtb $(DTB) --output . --sdf $(SYSTEM_FILE) --objcopy $(OBJCOPY)
	$(OBJCOPY) --update-section .device_resources=timer_driver_device_resources.data timer_driver.elf
	$(OBJCOPY) --update-section .timer_client_config=timer_client_scheduler.data scheduler.elf

$(IMAGE_FILE) $(REPORT_FILE): $(IMAGES) $(SYSTEM_FILE)
	$(MICROKIT_TOOL) $(SYSTEM_FILE) --search-path $(TOP_BUILD_DIR) --board $(MICROKIT_BOARD) --config $(MICROKIT_CONFIG) -o $(IMAGE_FILE) -r $(REPORT_FILE)


FORCE:

qemu: $(IMAGE_FILE)
	$(QEMU) -nographic $(QEMU_ARCH_ARGS)

clean::
	${RM} -f *.elf .depend* $
	find . -name \*.[do] |xargs --no-run-if-empty rm

clobber:: clean
	rm -f *.a
	rm -f ${IMAGE_FILE} ${REPORT_FILE}
