#![cfg_attr(not(test), no_std)]

#![allow(non_camel_case_types)]
#![allow(non_snake_case)]
#![allow(non_upper_case_globals)]

#![allow(dead_code)]
#![allow(static_mut_refs)]
#![allow(unused_imports)]
#![allow(unused_macros)]
#![allow(unused_parens)]
#![allow(unused_unsafe)]
#![allow(unused_variables)]

// Do not edit this file as it will be overwritten if codegen is rerun

mod bridge;
mod component;
mod logging;
mod tests;

use crate::bridge::thermostat_rt_mhs_mhs_api::{self as api, *};
use crate::component::thermostat_rt_mhs_mhs_app::*;
use data::*;

#[allow(unused_imports)]
use log::{error, warn, info, debug, trace};

static mut app: Option<thermostat_rt_mhs_mhs> = None;
static mut init_api: thermostat_rt_mhs_mhs_Application_Api<thermostat_rt_mhs_mhs_Initialization_Api> = api::init_api();
static mut compute_api: thermostat_rt_mhs_mhs_Application_Api<thermostat_rt_mhs_mhs_Compute_Api> = api::compute_api();

#[no_mangle]
pub extern "C" fn thermostat_rt_mhs_mhs_initialize() {
  #[cfg(not(test))]
  #[cfg(feature = "sel4")]
  logging::LOGGER.set().unwrap();

  unsafe {
    #[cfg(test)]
    crate::bridge::extern_c_api::initialize_test_globals();

    let mut _app = thermostat_rt_mhs_mhs::new();
    _app.initialize(&mut init_api);
    app = Some(_app);
  }
}

#[no_mangle]
pub extern "C" fn thermostat_rt_mhs_mhs_timeTriggered() {
  unsafe {
    if let Some(_app) = app.as_mut() {
      _app.timeTriggered(&mut compute_api);
    } else {
      panic!("Unexpected: app is None");
    }
  }
}

#[no_mangle]
pub extern "C" fn thermostat_rt_mhs_mhs_notify(channel: microkit_channel) {
  unsafe {
    if let Some(_app) = app.as_mut() {
      _app.notify(channel);
    } else {
      panic!("Unexpected: app is None");
    }
  }
}

// Need a Panic handler in a no_std environment
#[panic_handler]
#[cfg(not(test))]
fn panic(info: &core::panic::PanicInfo) -> ! {
  error!("PANIC: {info:#?}");
  loop {}
}
